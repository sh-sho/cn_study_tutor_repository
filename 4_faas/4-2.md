## 4-2 Function as a Serviceの基礎

### 1. API GatewayのAPIエンドポイントを実行して、#4-1(4)で作成したFunctionsが実行されるようにしてください

1. API GatewayがFunctionsを実行できるようにポリシー設定を行う。
   
`Allow any-user to use functions-family in compartment <Compartment>`

2. API Gatewayを作成する。
   ![apigateway](./images/apiGateway01.png)

3. デプロイメントを作成する。
  ![1/3](./images/apiGateway02.png)
  ![2/3](./images/apiGateway03.png)
  ![3/3](./images/apiGateway04.png)

4. OCIコンソール上からデプロイメントのエンドポイントにcurlする。

```console
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" -d '{"locate":"US"}' https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/func
-g
{"message":"Hello"}
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" -d '{"locate":"Europe"}' https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/
func-g
{"message":"こんにちは"}
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/func-g
{"message":"こんにちは"}
[opc@admin2-vm1 func-g]$ 
```

補足: Postmanを利用してテストする
![](./postman01.png)
![](./postman02.png)


### 2. Object Storage – BucketにCSVファイルが置かれたことをトリガーにOCI Functionsを実行し、そのCSVファイルをJSON形式に変換して別のBucketに格納してください

参考URL：https://docs.oracle.com/en-us/iaas/Content/Functions/Tasks/functions_pbf_catalog_object_storage_extractor.htm
https://github.com/oracle-samples/oracle-functions-samples


https://github.com/oracle-samples/oracle-functions-samples/blob/master/samples/oci-objectstorage-copy-objects-python/README.md

1. git cloneでスクリプトをダウンロード

```console
[opc@admin2-vm1 4-FaaS_standard_2ndSeason]$ git clone https://github.com/oracle-samples/oracle-functions-samples.git
Cloning into 'oracle-functions-samples'...
remote: Enumerating objects: 1485, done.
remote: Counting objects: 100% (238/238), done.
remote: Compressing objects: 100% (77/77), done.
remote: Total 1485 (delta 191), reused 173 (delta 161), pack-reused 1247
Receiving objects: 100% (1485/1485), 6.44 MiB | 24.08 MiB/s, done.
Resolving deltas: 100% (764/764), done.
[opc@admin2-vm1 4-FaaS_standard_2ndSeason]$ cd oracle-functions-samples/
[opc@admin2-vm1 oracle-functions-samples]$ ls -a
.  ..  CONTRIBUTING.md  .git  images  LICENSE.txt  README.md  samples  SECURITY.md  THIRD_PARTY_LICENSES_DEV.txt  THIRD_PARTY_LICENSES.txt
[opc@admin2-vm1 oracle-functions-samples]$ rm .git
rm: cannot remove '.git': Is a directory
[opc@admin2-vm1 oracle-functions-samples]$ rm -fR .git
[opc@admin2-vm1 oracle-functions-samples]$ ls -a
.  ..  CONTRIBUTING.md  images  LICENSE.txt  README.md  samples  SECURITY.md  THIRD_PARTY_LICENSES_DEV.txt  THIRD_PARTY_LICENSES.txt
[opc@admin2-vm1 oracle-functions-samples]$ 
[opc@admin2-vm1 oracle-functions-samples]$ 
[opc@admin2-vm1 oracle-functions-samples]$ cd samples/
[opc@admin2-vm1 samples]$ ll
total 0
drwxr-xr-x 2 opc opc  99 Mar  5 06:09 basic-observability
drwxr-xr-x 5 opc opc  63 Mar  5 06:09 helloworld
drwxr-xr-x 3 opc opc 126 Mar  5 06:09 imagedims-python
drwxr-xr-x 3 opc opc 111 Mar  5 06:09 oci-adb-client-runsql-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-adb-ords-runsql-python
drwxr-xr-x 3 opc opc 111 Mar  5 06:09 oci-apigw-apikey-validation-python
drwxr-xr-x 4 opc opc  98 Mar  5 06:09 oci-apigw-authorizer-idcs-java
drwxr-xr-x 3 opc opc 111 Mar  5 06:09 oci-apigw-display-httprequest-info-python
drwxr-xr-x 4 opc opc  80 Mar  5 06:09 oci-apigw-idcs-auth-basic
drwxr-xr-x 2 opc opc  75 Mar  5 06:09 oci-apigw-nosql-node
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-compute-control-python
drwxr-xr-x 3 opc opc  37 Mar  5 06:09 oci-cross-tenancy-policies-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-email-send-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-event-display-python
drwxr-xr-x 3 opc opc 110 Mar  5 06:09 oci-invoke-function-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-list-compartments-python
drwxr-xr-x 4 opc opc  80 Mar  5 06:09 oci-list-instances-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-list-instances-python
drwxr-xr-x 3 opc opc 144 Mar  5 06:09 oci-load-file-into-adw-python
drwxr-xr-x 3 opc opc 110 Mar  5 06:09 oci-logs-datadog
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-monitoring-metric-export-python
drwxr-xr-x 3 opc opc 130 Mar  5 06:09 oci-monitoring-metrics-to-datadog-python
drwxr-xr-x 5 opc opc  95 Mar  5 06:09 oci-notification-syniverse
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-copy-objects-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-create-par-python
drwxr-xr-x 3 opc opc  83 Mar  5 06:09 oci-objectstorage-custom-cert-put-object-go
drwxr-xr-x 4 opc opc  80 Mar  5 06:09 oci-objectstorage-custom-cert-put-object-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-custom-cert-put-object-python
drwxr-xr-x 3 opc opc  84 Mar  5 06:09 oci-objectstorage-custom-cert-put-object-ruby
drwxr-xr-x 4 opc opc  80 Mar  5 06:09 oci-objectstorage-get-object-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-get-object-python
drwxr-xr-x 4 opc opc 166 Mar  5 06:09 oci-objectstorage-list-objects-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-list-objects-python
drwxr-xr-x 4 opc opc  80 Mar  5 06:09 oci-objectstorage-put-object-java
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-objectstorage-put-object-python
drwxr-xr-x 4 opc opc  78 Mar  5 06:09 oci-oic-hcm-object-upload
drwxr-xr-x 3 opc opc 159 Mar  5 06:09 oci-ons-compute-shape-increase-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-ons-publish-python
drwxr-xr-x 3 opc opc 110 Mar  5 06:09 oci-serviceconnector-streaming-json-to-csv-python
drwxr-xr-x 3 opc opc 110 Mar  5 06:09 oci-serviceconnector-streaming-json-to-parquet-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-stop-untagged-instance-python
drwxr-xr-x 3 opc opc  93 Mar  5 06:09 oci-vault-decrypt-python
drwxr-xr-x 3 opc opc 111 Mar  5 06:09 oci-vault-get-secret-python
drwxr-xr-x 4 opc opc  51 Mar  5 06:09 trace-functions-with-apm
[opc@admin2-vm1 samples]$ 
[opc@admin2-vm1 samples]$ 
[opc@admin2-vm1 samples]$ cd oci-objectstorage-copy-objects-python
[opc@admin2-vm1 oci-objectstorage-copy-objects-python]$ ll
total 20
-rw-r--r-- 1 opc opc 2078 Mar  5 06:09 func.py
-rw-r--r-- 1 opc opc  235 Mar  5 06:09 func.yaml
drwxr-xr-x 2 opc opc   50 Mar  5 06:09 images
-rw-r--r-- 1 opc opc 5891 Mar  5 06:09 README.md
-rw-r--r-- 1 opc opc   23 Mar  5 06:09 requirements.txt
```

2. Fnをデプロイ

```console
[opc@admin2-vm1 oci-objectstorage-copy-objects-python]$ fn -v deploy --app myapp
Deploying oci-objectstorage-copy-objects-python to app: myapp
Bumped to version 0.0.2
Using Container engine docker
Building image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python:0.0.2 
Dockerfile content
-----------------------------------
FROM fnproject/python:3.8-dev as build-stage
WORKDIR /function
ADD requirements.txt /function/

                        RUN pip3 install --target /python/  --no-cache --no-cache-dir -r requirements.txt &&\
                            rm -fr ~/.cache/pip /tmp* requirements.txt func.yaml Dockerfile .venv &&\
                            chmod -R o+r /python
ADD . /function/
RUN rm -fr /function/.pip_cache
FROM fnproject/python:3.8
WORKDIR /function
COPY --from=build-stage /python /python
COPY --from=build-stage /function /function
RUN chmod -R o+r /function
ENV PYTHONPATH=/function:/python
ENTRYPOINT ["/python/bin/fdk", "/function/func.py", "handler"]
-----------------------------------
FN_REGISTRY:  nrt.ocir.io/nrruovdjeqty/myapp-repo-go
Current Context:  CloudNativeComp
TargetedPlatform:  amd64HostPlatform:  amd64
[+] Building 19.5s (10/16)                                                                                                                                             docker:default
 => [internal] load .dockerignore                                                                                                                                                0.0s
 => => transferring context: 2B                                                                                                                                                  0.0s
 => [internal] load metadata for docker.io/fnproject/python:3.8                                                                                                                  3.3s
 => [internal] load metadata for docker.io/fnproject/python:3.8-dev                                                                                                              2.2s
 => [build-stage 1/6] FROM docker.io/fnproject/python:3.8-dev@sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6                                            3.1s
 => => resolve docker.io/fnproject/python:3.8-dev@sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6                                                        0.0s
 => => sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6 1.61kB / 1.61kB                                                                                   0.0s
 => => sha256:f655d8801d1aeb3688eb65af5cb0c5873ca44a66b0258637f59a5822237fbcd2 675B / 675B                                                                                       0.0s
 => => sha256:ab117a67bf403122a4dee6188408eb463c52109a9b6c69db4547a6f745b4cf73 1.41kB / 1.41kB                                                                                   0.0s
 => => sha256:04f72a5a1243013638072b5163fbaded5adb2247c3fef56f8f6eb9e096a8782e 18.05MB / 18.05MB                                                                                 1.1s
 => => extracting sha256:04f72a5a1243013638072b5163fbaded5adb2247c3fef56f8f6eb9e096a8782e                                                                                        1.4s
 => [stage-1 1/5] FROM docker.io/fnproject/python:3.8@sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b                                                    4.5s
 => => resolve docker.io/fnproject/python:3.8@sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b                                                            0.0s
 => => sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b 1.61kB / 1.61kB                                                                                   0.0s
 => => sha256:a9b46393ac95c4363c961023f342a43952b7a53e14f0c092e216350275ff8255 863B / 863B                                                                                       0.0s
 => => sha256:4a38b19726ee9d3913918563256085862b7e08037fd88ab19e12bee1107d3f3e 1.69kB / 1.69kB                                                                             [+] Building 79.6s (17/17) FINISHED                                                                                                                         docker:default
 => [internal] load build definition from Dockerfile1636897850                                                                                                        0.0s 
 => => transferring dockerfile: 643B                                                                                                                                  0.0s
 => [internal] load .dockerignore                                                                                                                                     0.0s 
 => => transferring context: 2B                                                                                                                                       0.0s
 => [internal] load metadata for docker.io/fnproject/python:3.8                                                                                                       3.3s 
 => [internal] load metadata for docker.io/fnproject/python:3.8-dev                                                                                                   2.2s
 => [build-stage 1/6] FROM docker.io/fnproject/python:3.8-dev@sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6                                 3.1s 
 => => resolve docker.io/fnproject/python:3.8-dev@sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6                                             0.0s
 => => sha256:079a0dcbb02e63f5efeb73c480248880fd1e9c924d645ba5320a5c400f972ad6 1.61kB / 1.61kB                                                                        0.0s 
 => => sha256:f655d8801d1aeb3688eb65af5cb0c5873ca44a66b0258637f59a5822237fbcd2 675B / 675B                                                                            0.0s
 => => sha256:ab117a67bf403122a4dee6188408eb463c52109a9b6c69db4547a6f745b4cf73 1.41kB / 1.41kB                                                                        0.0s 
 => => sha256:04f72a5a1243013638072b5163fbaded5adb2247c3fef56f8f6eb9e096a8782e 18.05MB / 18.05MB                                                                      1.1s
 => => extracting sha256:04f72a5a1243013638072b5163fbaded5adb2247c3fef56f8f6eb9e096a8782e                                                                             1.4s 
 => [stage-1 1/5] FROM docker.io/fnproject/python:3.8@sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b                                         4.5s
 => => resolve docker.io/fnproject/python:3.8@sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b                                                 0.0s 
 => => sha256:65f34f5c868ce023587086a2bd13578cc310ec9d35fc7a4ce3608c2ae2d3ea3b 1.61kB / 1.61kB                                                                        0.0s
 => => sha256:a9b46393ac95c4363c961023f342a43952b7a53e14f0c092e216350275ff8255 863B / 863B                                                                            0.0se
 => => sha256:4a38b19726ee9d3913918563256085862b7e08037fd88ab19e12bee1107d3f3e 1.69kB / 1.69kB                                                                        0.0s
 => => sha256:45980975d4e54bff2d42c2d935a2ef332560a45630e243699900f796a1217359 18.05MB / 18.05MB                                                                      2.4s 
 => => sha256:3c00eaf52d0eeb12ffa05109b60767b4b521f4bb592694aa5351b2c230e4ecb9 883B / 883B                                                                            0.5s
 => => extracting sha256:45980975d4e54bff2d42c2d935a2ef332560a45630e243699900f796a1217359                                                                             1.9s 
 => => extracting sha256:3c00eaf52d0eeb12ffa05109b60767b4b521f4bb592694aa5351b2c230e4ecb9                                                                             0.0s
 => [internal] load build context                                                                                                                                     0.0s 
 => => transferring context: 138.62kB                                                                                                                                 0.0s
 => [build-stage 2/6] WORKDIR /function                                                                                                                               0.6s 
 => [build-stage 3/6] ADD requirements.txt /function/                                                                                                                 0.1s
 => [build-stage 4/6] RUN pip3 install --target /python/  --no-cache --no-cache-dir -r requirements.txt &&       rm -fr ~/.cache/pip /tmp* requirements.txt func.ya  49.1s 
 => [stage-1 2/5] WORKDIR /function                                                                                                                                   0.0s
 => [build-stage 5/6] ADD . /function/                                                                                                                                0.1s 
 => [build-stage 6/6] RUN rm -fr /function/.pip_cache                                                                                                                 0.3s 
 => [stage-1 3/5] COPY --from=build-stage /python /python                                                                                                             3.1s 
 => [stage-1 4/5] COPY --from=build-stage /function /function                                                                                                         0.0s 
 => [stage-1 5/5] RUN chmod -R o+r /function                                                                                                                          0.2s
 => exporting to image                                                                                                                                               16.6s
 => => exporting layers                                                                                                                                              16.5s
 => => writing image sha256:2714335f29730065d94c6e0b67407dd2ee6eabada472a9c1bbb1aaae07053bf0                                                                          0.0s
 => => naming to nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python:0.0.2                                                                   0.0s

Using Container engine  docker  to push
Pushing nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python:0.0.2 to docker registry...The push refers to repository [nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python]
696355209e35: Pushed 
7948a0fe4cdd: Pushed 
3ac0c463cc49: Pushed 
1a62862c176a: Pushed 
3c51a1341037: Pushed 
bca801aa5c5d: Pushed 
7e9f3f6c7a0a: Pushed 
0.0.2: digest: sha256:70a19a5ca890073177ad17f3a3dcaec876ceb171df2c504be7e9e83123dc06d3 size: 1783
Updating function oci-objectstorage-copy-objects-python using image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python:0.0.2...
Successfully created function: oci-objectstorage-copy-objects-python with nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-copy-objects-python:0.0.2
```

3. 対象Bucketのオブジェクト・イベントの出力を有効化


### 3. OCI Streamingに格納されたメッセージをSCHを用いてOCI Functionsに連携してください
### 3-1. Functionはそのメッセージをログに出力し、OCI Loggingから参照できるようにしてください
### 4. FunctionsからBaseDB or ADBに接続してSELECT文の結果を表示してください
