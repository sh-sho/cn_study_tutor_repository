## 4-2 Function as a Serviceの基礎

### 1. API GatewayのAPIエンドポイントを実行して、#4-1(4)で作成したFunctionsが実行されるようにしてください

1. API GatewayがFunctionsを実行できるようにポリシー設定を行う。
   
`Allow any-user to use functions-family in compartment <Compartment>`

2. API Gatewayを作成する。
   ![apigateway](./images/apiGateway01.png)

3. デプロイメントを作成する。
  ![1/3](./images/apiGateway02.png)
  ![2/3](./images/apiGateway03.png)
  ![3/3](./images/apiGateway04.png)

4. OCIコンソール上からデプロイメントのエンドポイントにcurlする。

```console
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" -d '{"locate":"US"}' https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/func
-g
{"message":"Hello"}
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" -d '{"locate":"Europe"}' https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/
func-g
{"message":"こんにちは"}
[opc@admin2-vm1 func-g]$ curl -X GET -H "Content-Type: application/json" https://ibukjfueccn3k6e46kj6yywpde.apigateway.ap-tokyo-1.oci.customer-oci.com/deploy/func-g
{"message":"こんにちは"}
[opc@admin2-vm1 func-g]$ 
```

補足: Postmanを利用してテストする
![](./postman01.png)
![](./postman02.png)


### 2. Object Storage – BucketにCSVファイルが置かれたことをトリガーにOCI Functionsを実行し、そのCSVファイルをJSON形式に変換して別のBucketに格納してください

参考URL：https://docs.oracle.com/en-us/iaas/Content/Functions/Tasks/functions_pbf_catalog_object_storage_extractor.htm
https://github.com/oracle-samples/oracle-functions-samples


https://github.com/oracle-samples/oracle-functions-samples/blob/master/samples/oci-objectstorage-copy-objects-python/README.md

https://github.com/kenwatan/functions_Load_ADB_python_Secrets/blob/master/func.py

1. ポリシー設定
   

2. `https://github.com/oracle-samples/oracle-functions-samples.git`からgit cloneでファイルをダウンロード

```console
[opc@admin2-vm1 4-FaaS_standard_2ndSeason]$ git clone https://github.com/oracle-samples/oracle-functions-samples.git

```

1. Fnをデプロイ

```console
[opc@admin2-vm1 oci-objectstorage-copy-objects-python]$ fn deploy --app myapp
Deploying oci-objectstorage-change-csv-json-objects-python to app: myapp
Bumped to version 0.0.4
Using Container engine docker
Building image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-change-csv-json-objects-python:0.0.4 TargetedPlatform:  amd64HostPlatform:  amd64
......
Using Container engine  docker  to push
Pushing nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-change-csv-json-objects-python:0.0.4 to docker registry...The push refers to repository [nrt.ocir.io/n
rruovdjeqty/myapp-repo-go/oci-objectstorage-change-csv-json-objects-python]                                                                                            7fbaf0ffdf6e: Pushed 
11f654cb43d9: Pushed 
3ac0c463cc49: Pushed 
1a62862c176a: Pushed 
3c51a1341037: Pushed 
bca801aa5c5d: Pushed 
7e9f3f6c7a0a: Pushed 
0.0.4: digest: sha256:1c8a05d6ec45aa37e3b855440cb4022cf175b3dbe40d8f97ea7965ecf0e70048 size: 1781
Updating function oci-objectstorage-change-csv-json-objects-python using image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-change-csv-json-objects-python:
0.0.4...                                                                                                                                                               Successfully created function: oci-objectstorage-change-csv-json-objects-python with nrt.ocir.io/nrruovdjeqty/myapp-repo-go/oci-objectstorage-change-csv-json-objects-p
ython:0.0.4                                                                                                                                                            
```

3. 対象Bucketのオブジェクト・イベントの出力を有効化


### 3. OCI Streamingに格納されたメッセージをSCHを用いてOCI Functionsに連携してください
### 3-1. Functionはそのメッセージをログに出力し、OCI Loggingから参照できるようにしてください
### 4. FunctionsからBaseDB or ADBに接続してSELECT文の結果を表示してください
