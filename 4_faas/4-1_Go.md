## Go言語でのFunctions実装


### 2. 実行すると、{“message”: “こんにちは”}と返すFunctionを実装し、ローカルで実行してください

Functionsのスタートガイドからデプロイしたプログラム`func.go`を修正

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"io"
	"log"

	fdk "github.com/fnproject/fdk-go"
)

func main() {
	fdk.Handle(fdk.HandlerFunc(myHandler))
}

type Person struct {
	Name string `json:"name"`
}

func myHandler(ctx context.Context, in io.Reader, out io.Writer) {
	// p := &Person{Name: "World"} 
	p := &Person{Name: "こんにちは"}   // 追加
	json.NewDecoder(in).Decode(p)
	msg := struct {
		Msg string `json:"message"`
	}{
		// Msg: fmt.Sprintf("Hello %s", p.Name),
		Msg: fmt.Sprintf("%s", p.Name),   // 追加
	}
	log.Print("Inside Go Hello World function")
	json.NewEncoder(out).Encode(&msg)
}
```

```console
[opc@admin2-vm1 func-g]$ fn deploy --app myapp
Deploying func-g to app: myapp
Bumped to version 0.0.3
Using Container engine docker
Building image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/func-g:0.0.3 TargetedPlatform:  amd64HostPlatform:  amd64
...
Using Container engine  docker  to push
Pushing nrt.ocir.io/nrruovdjeqty/myapp-repo-go/func-g:0.0.3 to docker registry...The push refers to repository [nrt.ocir.io/nrruovdjeqty/myapp-repo-go/func-g]
76d6899e2603: Pushed 
5093f273c9f7: Layer already exists 
c8d37778d78b: Layer already exists 
7e9f3f6c7a0a: Layer already exists 
0.0.3: digest: sha256:ab42a0890007bde302256f650f521ad7e188fb88ed3e4a124f82d6a7dab26cf6 size: 1154
Updating function func-g using image nrt.ocir.io/nrruovdjeqty/myapp-repo-go/func-g:0.0.3...
[opc@admin2-vm1 func-g]$ 
[opc@admin2-vm1 func-g]$ 
[opc@admin2-vm1 func-g]$ fn invoke myapp func-g
{"message":"こんにちは"}
[opc@admin2-vm1 func-g]$ 
```

### 3. 2. で作成したFunctionを以下のように修正してください
#### 3-1. {“locate”: “US”}を受け取った際に、{“message”: “Hello”}を返す
#### 3-2. 入力がない場合は、{“message”: “こんにちは”}を返す

`func.go`を修正

```go
package main

import (
	"context"
	"encoding/json"
	"io"
	"log"

	fdk "github.com/fnproject/fdk-go"
)

func main() {
	fdk.Handle(fdk.HandlerFunc(myHandler))
}

type Locate struct {
	Name string `json:"locate"` // add
}

func myHandler(ctx context.Context, in io.Reader, out io.Writer) {
	l := &Locate{} // add
	err := json.NewDecoder(in).Decode(l)
	log.Println(err)
	if err != nil {
		log.Printf("Error decodeing request: %v", err)
	}
	msg := struct {
		Msg string `json:"message"`
	}{}
	if l.Name == "US" {
		msg.Msg = "Hello"
	} else {
		msg.Msg = "こんにちは"
	}
	log.Print("Inside Go Hello World function")
	log.Println(&msg)
	log.Println(&msg.Msg)
	err = json.NewEncoder(out).Encode(&msg)
	if err != nil {
		log.Printf("Error encoding response: %v", err)
	}
}
```

{"locate":"US"}を引数として渡すと{"message":"Hello"}を戻す

```console
[opc@admin2-vm1 func-g]$ time echo '{"locate":"US"}' | fn invoke myapp func-g
{"message":"Hello"}

real    0m1.103s
user    0m0.069s
sys     0m0.010s
[opc@admin2-vm1 func-g]$ 
```

引数がないときは{"message":"こんにちは"}を戻す

```console
[opc@admin2-vm1 func-g]$ time fn invoke myapp func-g
{"message":"こんにちは"}

real    0m0.304s
user    0m0.069s
sys     0m0.012s
[opc@admin2-vm1 func-g]$ 
```

他の引数を渡しても{"message":"こんにちは"}を戻す

```console
[opc@admin2-vm1 func-g]$ time echo '{"locate":"JAPAN"}' | fn invoke myapp func-g
{"message":"こんにちは"}

real    0m0.301s
user    0m0.066s
sys     0m0.013s
[opc@admin2-vm1 func-g]$ time echo '{"message":"US"}' | fn invoke myapp func-g
{"message":"こんにちは"}

real    0m0.296s
user    0m0.062s
sys     0m0.015s
[opc@admin2-vm1 func-g]$ 
```

### Tips

- Functionsの起動時間

Functionsの初回起動時間はだいたい20秒ぐらい。2回目以降は数百ミリ秒。

```console
[opc@admin2-vm1 func-g]$ time fn invoke myapp func-g


real    0m19.179s
user    0m0.073s
sys     0m0.008s
[opc@admin2-vm1 func-g]$ 
[opc@admin2-vm1 func-g]$ time fn invoke myapp func-g


real    0m0.316s
user    0m0.061s
sys     0m0.015s
[opc@admin2-vm1 func-g]$ 
```
