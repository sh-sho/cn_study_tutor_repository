# 4-1-2で作成したFunctionsを{“message”: “Hi there”}が返却されるように修正してください
## ただし、OCI Functionsへの反映はGitHubリポジトリへの更新をトリガーにOCI DevOpsを用いて自動的に行われるようにしてください
東京リージョンなら、Default Vault Countの数に余りがあるが、
funtionが上限を超えている、、、（funtionはテナント的に余りがないというエラー。アシュバンでも作れない）
⇒アプリケーションとOICRは別リージョンにあるとだめそう、、
外部接続＝Default　同じリージョン必須
アプリケーション＝OICR　同じリージョン必須

### 環境
・ファンクション、OCIR：アシュバンリージョン<br>
・devops環境全般：東京リージョン<br>
 ※プロジェクトの環境で、他リージョンのFunctionを紐づけられる<br>
 
Vaultのlimitの関係で、devops全般は東京リージョンで作成してます<br>

## 0. 事前準備
### githubでtokenを作成
[fine-grained personal access token の作成](https://docs.github.com/ja/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#fine-grained-personal-access-token-%E3%81%AE%E4%BD%9C%E6%88%90)
<br>

### OCI Vault上でマスター暗号鍵とシークレットを作成
マスター暗号鍵
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/0d0b7083-a73e-4427-936b-4c09028d24d8)

シークレット<br>
暗号キーの部分で先ほど作成したマスター暗号鍵を選択<br>
手動シークレットを選択し、githubで作成したtokenを入力
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/e8d626a1-9f26-49b7-98b0-0323a12deead)


### ポリシーの追加<br>
詳細は
[ドキュメント](https://docs.oracle.com/ja-jp/iaas/Content/devops/using/getting_started.htm#prereq)を見てください。

ちなみに、私の環境でつけたポリシーは以下
```
Allow dynamic-group <dynamic_group> to manage devops-family in compartment <コンパートメント名>
Allow dynamic-group <dynamic_group> to manage all-artifacts in compartment <コンパートメント名>
Allow dynamic-group <dynamic_group> to use ons-topics in compartment <コンパートメント名>
Allow dynamic-group <dynamic_group> to manage functions-family in compartment <コンパートメント名>
Allow dynamic-group <dynamic_group>to manage cluster-family in compartment <コンパートメント名>
Allow dynamic-group <dynamic_group> to read secret-family in compartment <コンパートメント名>
Allow group <group> to use devops-connection in compartment <コンパートメント名>
```
私の場合、ポリシーに不足があって、外部接続の検証で失敗し続けました<br>
動的ポリシーは省略。

### OCIRの作成　⇒　第４回目の時に作成していない人は作成しましょう
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/39790566-7448-4163-abd8-b32244891ec3)


### アプリケーションとfunction作成　⇒　第４回目の時に作成していない人は作成しましょう
```
cd fn-hello
fn deploy --app <app名>
fn invoke <app名> <function名>
```
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/c32b3501-359a-43d0-8e9f-f03873b559ad)

### build_spec.yamlの準備

build_spec.yaml の仕様に関しては [こちら](https://docs.oracle.com/ja-jp/iaas/Content/devops/using/build_specs.htm)のドキュメントを確認<br>
ちなみに私のコードは
[こちら](https://github.com/sh-sho/cn_study_tutor_repository/blob/7_tokunaga/7_cicd/fn-hello/build_spec.yaml)

## 1. プロジェクトの作成
・プロジェクト名の決定<br>
・トピックの選択<br>

<img width="391" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/c54709ea-9073-4434-a7c1-f049337271eb"><br>
・ログの有効化<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/544dac36-48d5-4bdb-a42a-9e795eeb1496)

## 2. 外部接続の作成
・タイプ：GitHub<br>
・ボールド・シークレット：作成したマスター暗号鍵とシークレットを選択<br>


<img width="622" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/59c96cfe-a40e-451c-80a1-9131a2b27b84">


## 3. コード・リポジトリの作成とミラーリングを設定
・リポジトリ名を設定する<br>
<img width="560" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/eff08154-0fa5-485a-888d-28b2048c8dce">
<br>

・作成したコード・リポジトリから、ミラーリングの設定をする<br>
前段階で作成した外部接続を選択し、ミラーリングしたいリポジトリを選択する<br>

<img width="580" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/7fc33237-907e-4f82-afeb-a2f7f2ffb15c">



## 4. ビルド・パイプラインの作成
#### ビルド・パイプライン名を設定<br>
<img width="532" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/761eecee-3f99-40bf-9181-7911a26bed07">

#### ステージの追加（ステージタイプ：マネージド・ビルド）<br>
ビルド仕様ファイル・パス： `build_spec.yaml`<br>
プライマリ・コード・リポジトリ:githubを選択し、対象のリポジトリを選択<br>
<img width="623" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/87abd5af-bcfa-4021-a6be-55629cbdcad4">
<br>


#### ステージの追加（ステージタイプ：アーティファクトの配信）<br>
アーティファクトの作成　＞　タイプ：コンテナ・イメージ・リポジトリ<br>
アーティファクトとビルド結果の関連付け　＞　ビルド構成/結果アーティファクト名：fn-hello-image<br>
<img width="334" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/a5d04066-ac63-47cf-90cc-47b85c4841a8"><br>



## 5. 環境の作成
環境タイプ：ファンクション<br>
リージョン：functionがあるリージョンを選択。該当するアプリケーションとFunctionを選択<br>

ここで別リージョンのアプリケーションでも選択することができる<br>

![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/a7bf46d8-52a0-4893-8b9a-6882688eb218)<br>


## 6. デプロイメント・パイプラインの作成
#### ステージの追加（ステージタイプ>デプロイ:ファンクション デフォルト）<br>
・環境：作成したものを選択<br>
・アーティファクト：作成したものを選択<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/d8c6e782-1f31-4a22-a83e-5b513a1874e2)<br>



## 7.ビルド・パイプラインとデプロイメント・パイプラインの連携
#### ステージの追加（ステージタイプ:デプロイのトリガー）<br>
作成したデプロイパイプラインを選択<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/b0c73574-b1ee-48de-be5c-4cfba7d744a7)<br>



## 8.トリガーの作成
ソース接続: OCI コード・リポジトリ<br>
コード・リポジトリの選択: 作成したコード・リポジトリ<br>
アクションの追加：作成したビルド・パイプラインの選択<br>
イベント: push<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/36c91ab7-4082-4c06-9c88-31c9da8352f0)<br>



## 9.いざ実行

`func.py`を今回のお題用に書き直す
```
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ ls
build_spec.yaml  fn-hello-python-github
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ pwd
/home/ritsuko_to/7_CICD/fn-hello
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ cd fn-hello-python-github/
ritsuko_to@cloudshell:fn-hello-python-github (us-ashburn-1)$ ls
func.py  func.yaml  requirements.txt
ritsuko_to@cloudshell:fn-hello-python-github (us-ashburn-1)$ cat func.py 
import io
import json
import logging

from fdk import response


def handler(ctx, data: io.BytesIO = None):
    name = "World"
    try:
        body = json.loads(data.getvalue())
        name = body.get("name")
    except (Exception, ValueError) as ex:
        logging.getLogger().info('error parsing json payload: ' + str(ex))

    logging.getLogger().info("Inside Python Hello World function")
    return response.Response(
        ctx, response_data=json.dumps(
            {"message": "HelloRITSUKO {0}".format(name)}),
        headers={"Content-Type": "application/json"}
    )
ritsuko_to@cloudshell:fn-hello-python-github (us-ashburn-1)$ vi func.py 
ritsuko_to@cloudshell:fn-hello-python-github (us-ashburn-1)$ cat func.py 
import io
import json
import logging

from fdk import response


def handler(ctx, data: io.BytesIO = None):
    name = "World"
    try:
        body = json.loads(data.getvalue())
        name = body.get("name")
    except (Exception, ValueError) as ex:
        logging.getLogger().info('error parsing json payload: ' + str(ex))

    logging.getLogger().info("Inside Python Hello World function")
    return response.Response(
        ctx, response_data=json.dumps(
            {"message": "Hi there {0}".format(name)}),
        headers={"Content-Type": "application/json"}
    )
ritsuko_to@cloudshell:fn-hello-python-github (us-ashburn-1)$ cd ../
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ ls
build_spec.yaml  fn-hello-python-github
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git add -A.
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git add -A .
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git commit -m "hi there"
[main 513a3b7] hi there
 1 file changed, 1 insertion(+), 1 deletion(-)
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git branch -M main
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git remote add origin https://github.com/ritokuna/fn-hello.git
fatal: remote origin already exists.
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ git push -u origin main 
Username for 'https://github.com': ritokuna
Password for 'https://ritokuna@github.com': 
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 2 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 395 bytes | 395.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
To https://github.com/ritokuna/fn-hello.git
   5edf98a..513a3b7  main -> main
Branch 'main' set up to track remote branch 'main' from 'origin'.
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ 
```

github上に正しくpushできているか確認<br>
<img width="621" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/61656283-b644-439f-bd9c-6b1712e1dcbd">

<br>

コードリポジトリ上で今すぐ同期化を押して、githubとミラーリングさせる<br>
<img width="488" alt="image" src="https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/efe8360f-efe1-4fe9-a3ea-f2f4bf0e1dc0">

<br>

ビルド履歴から進行を見守る<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/e20f7cc4-1d89-4996-af3d-150800e39984)

<br>

全て上手くいったことを確認<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/93956dd8-4bbc-4761-ad65-384a775b4339)

ファンクション実行
```
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ fn invoke oci-devops-handson-app fn-hello-python
{"message": "Hi there World"}
ritsuko_to@cloudshell:fn-hello (us-ashburn-1)$ 
```


### memo 
・このチュートリアル、表記ブレではないか？<br>
https://oracle-japan.github.io/ocitutorials/cloud-native/devops-for-beginners-functions/#1ocir-%E3%81%AE%E4%BD%9C%E6%88%90
<br>多分unzipするファイル名が違う<br>
![image](https://github.com/sh-sho/cn_study_tutor_repository/assets/140580748/bc76f6f1-2918-4f5b-8395-0548c9972186)

・gitする際に、
https://oracle-japan.github.io/ocitutorials/cloud-native/devops-for-beginners-functions/#1-2%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA-%E3%81%AE%E4%BD%9C%E6%88%90
の方法では上手くいかないが、<br>
https://oracle-japan.github.io/ocitutorials/cloud-native/devops-for-beginners-oke/#2-1%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E4%BD%9C%E6%88%90
はうまくいく、なぜ？


